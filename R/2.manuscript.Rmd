---
title: "Manuscript"
author: "Kalyn Dorheim"
date: "10/25/2022"
output: 
  html_document:
    toc: yes
    toc_depth: '4'
    toc_float: yes
    number_sections: true
    date: "`r format(Sys.time(), '%d %B, %Y')`"
---

# Obejective 

Visualize and crunch the numbers used to generate figures for the Hector v3 manuscript. 

# Set Up 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, error = FALSE, message = FALSE)
# see https://bookdown.org/yihui/rmarkdown-cookbook/ for more info on markdowns
```

```{r, warning=FALSE, message = FALSE, echo=TRUE}
library(assertthat)
library(data.table)
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
library(readxl)
library(hector)
#devtools::load_all("~/projects/Hector-Versions/v3/hector/")

# Load some custom helpful functions
source(here::here("R", "0B.functions.R"))

# Set up the relative paths
BASE_DIR  <- here::here()
FIGS_DIR  <- here::here("output", "figures")
INPUT_DIR <- here::here("data")
HECTOR_RSLTS_DIR <- here::here("output", "hector_output")
#HECTOR_DATA_DIR <- "~/Documents/2022/hectordata/"

# Define some overall figure aesthetics
THEME_BASE_SIZE <- 10
theme_set(theme_bw(base_size = THEME_BASE_SIZE) + 
            theme(legend.title = element_blank()))
FULL_FIG <- data.frame(width = 7, height = 7)
MANUSCRIPT_FIG <- data.frame(width = 4, height = 3)

COLOR_SCHEME <- c("grey" = "#999999", "col1" = "#56B4E9", "black" = "#000000",
                  "#009E73", "#E69F00", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
SSP_COLORS <- c("ssp119" = "#00a9cf", "ssp126" = "#003466", "ssp245" = "#f69320",
                  "ssp370" = "#df0000", "ssp434" = "#2274ae","ssp460" = "#b0724e",
                  "ssp585"= "#980002", "historical" = "#000000", "historical"="#92397a")
OBS_SCHEME <- c("obs" = "grey", "Hector v3" = "#E69F00")
```

## Load Hector Results

```{r, echo=TRUE}
list.files(HECTOR_RSLTS_DIR, pattern = "rcp", full.names = TRUE) %>% 
  lapply(read.csv) %>% 
  do.call(what = "rbind") -> 
  hector_rcp

list.files(HECTOR_RSLTS_DIR, pattern = "ssp", full.names = TRUE) %>%
  lapply(read.csv) %>%
  do.call(what = "rbind") ->
  hector_ssp
```



# Comparison with Observations 

## Atmospheric CO~2~ 

```{r}
# Meinshausen, M., Vogel, E., Nauels, A., Lorbacher, K., Meinshausen, N., Etheridge, D. M., 
# Fraser, P. J., Montzka, S. A., Rayner, P. J., Trudinger, C. M., Krummel, P. B., Beyerle, 
# U., Canadell, J. G., Daniel, J. S., Enting, I. G., Law, R. M., Lunder, C. R., O'Doherty, 
# S., Prinn, R. G., Reimann, S., Rubino, M., Velders, G. J. M., Vollmer, M. K., Wang, 
# R. H. J., and Weiss, R.: Historical greenhouse gas concentrations for climate modelling 
# (CMIP6), Geosci. Model Dev., 10, 2057–2116, https://doi.org/10.5194/gmd-10-2057-2017, 2017.
here::here(INPUT_DIR, "Supplementary_Table_UoM_GHGConcentrations-1-1-0_annualmeans_v23March2017.csv") %>%  
  read.csv(skip = 21) %>% 
  na.omit %>% 
  select(year =  "v.YEARS.GAS..", value = "CO2") %>% 
  mutate(variable = "co2 obs") -> 
  cmip6_co2_obs


# Lan, X., Tans, P. and K.W. Thoning: Trends in globally-averaged CO2 determined 
# from NOAA Global Monitoring Laboratory measurements. Version 2023-01 NOAA/GML
# (gml.noaa.gov/ccgg/trends/)
# Mauna Loa CO2 - downloaded 2022-05-05 from https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_annmean_mlo.csv
read_csv(file.path(INPUT_DIR, "calibration", "co2_annmean_mlo.csv"),
         col_types = "ddd", comment = "#") %>% 
  rename(value = mean) %>% 
  mutate(which = "Mauna Loa") ->
  noaa_co2_obs

hector_ssp %>% 
  filter(version == "3.0.0" & variable == CONCENTRATIONS_CO2()) %>% 
  filter(scenario == "ssp119") %>%
  filter(year <= 2020) -> 
  hector_co2

ggplot() + 
  geom_line(data = cmip6_co2_obs, aes(year, value, color = "Meinshausen et al 2017"), size = 1) + 
  geom_line(data = noaa_co2_obs, aes(year, value, color = "Lan et al 2023"), size = 1) +
  geom_line(data = hector_co2, aes(year, value, color = "Hector v3"), size = 1.5, linetype = 2) + 
  scale_color_manual(values = c("Hector v3" = OBS_SCHEME[["Hector v3"]],
                                "Meinshausen et al 2017" = OBS_SCHEME[["obs"]],
                                "Lan et al 2023" = "black")) + 
  labs(x = "Year", y = expression('CO'[2]~' (ppm)')) + 
  theme(legend.position = "bottom") -> 
  plot; plot

ggsave(plot, filename = file.path(FIGS_DIR, "co2_observations.png"), 
       width = MANUSCRIPT_FIG$width, height = MANUSCRIPT_FIG$height)
```

## Global Mean Surface Temperature 

```{r}
# Lenssen, N., G. Schmidt, J. Hansen, M. Menne, A. Persin, R. Ruedy, and D. Zyss, 2019: 
# Improvements in the GISTEMP uncertainty model. J. Geophys. Res. Atmos., 124, no. 12, 
# 6307-6326, doi:10.1029/2018JD029522.
read.csv(file.path(INPUT_DIR, "calibration", "GISTEMP_v4_20221014.csv"), skip = 1) %>% 
  select(year = Year, value = `J.D`) %>% 
  mutate(value = as.numeric(value)) %>% 
  na.omit() %>% 
  mutate(variable = "gmst") %>% 
  na.omit -> 
  giss_gmst_obs

# Hadcrut5
# Global mean surface temperature anomaly
# https://www.metoffice.gov.uk/hadobs/hadcrut5/data/current/download.html
# The temperature anomaly is based off of 1961–1990
# surface temperature with the anomaly!
# Morice, C. P., Kennedy, J. J., Rayner, N. A., Winn, J. P., Hogan, E., Killick, R. E., et al. (2021). 
# An updated assessment of near-surface temperature change from 1850: the HadCRUT5 data 
# set. Journal of Geophysical Research: Atmospheres, 126, e2019JD032361. 
# https://doi.org/10.1029/2019JD032361
here::here(INPUT_DIR, "HadCRUT5.csv") %>%
  read.csv(stringsAsFactors = FALSE) %>% 
  na.omit -> 
  hadcrut_obs_data
names(hadcrut_obs_data) <- c("year", "value", "lower", "upper")
hadcrut_obs_data$variable <- "gmst"
hadcrut_obs_data <- normalize_to_giss(hadcrut_obs_data) 

yrs <- unique(c(giss_gmst_obs$year, hadcrut_obs_data$year))

hector_ssp %>% 
  filter(version == "3.0.0" & variable == "gmst") %>% 
  filter(scenario == "ssp119") %>%
  filter(year %in% yrs) %>% 
  normalize_to_giss %>% 
  na.omit -> 
  hector_gmst


ggplot() + 
  geom_line(data = hadcrut_obs_data, aes(year, value, color = "Morice et al 2020"), size = 1) + 
  geom_line(data = giss_gmst_obs, aes(year, value, color = "Lenssen et al 2019"), size = 1) + 
  geom_line(data = hector_gmst, aes(year, value, color = "Hector v3"), size = 1.5) + 
  scale_color_manual(values = c("Hector v3" = OBS_SCHEME[["Hector v3"]],
                                "Lenssen et al 2019" = "black",
                                "Morice et al 2020" = OBS_SCHEME[["obs"]])) + 
  labs(x = "Year", y = expression("Temperature anomaly relative to 1961–1990 ("~degree~"C)")) + 
  theme(legend.position = "bottom") -> 
  plot; plot

ggsave(plot, filename = file.path(FIGS_DIR, "gmst_observations.png"), 
       width = MANUSCRIPT_FIG$width+1, height = MANUSCRIPT_FIG$height + 1)
```


# CMIP6 Comparison 

```{r}
scns <- c("ssp245", "ssp126", "ssp585")

# G. A. Meehl, C. A. Senior, V. Eyring, G. Flato, J.-F. Lamarque, R. J. Stouffer, K. E. Taylor,
# M. Schlund, Context for interpreting equilibrium climate sensitivity and transient climate response
# from the CMIP6 Earth system models. Sci. Adv. 6, eaba1981 (2020). 
# Schlund, Manuel, Axel Lauer, Pierre Gentine, Steven C. Sherwood, and Veronika Eyring. 2020. “Emergent Constraints on Equilibrium Climate Sensitivity in CMIP5: Do They Hold for CMIP6?” Earth System Dynamics 11 (4): 1233–58.

# Lovato, T., Peano, D., Butenschön, M., Materia, S., Iovino, D., Scoccimarro, E.,
# et al. (2022). CMIP6 simulations with the CMCC Earth System Model (CMCCESM2). 
# Journal of Advances in Modeling Earth Systems, 14, e2021MS002814.
# https://doi.org/10.1029/2021MS002814
cmip6_ecs <- as.data.frame(rbind(c("ACCESS-CM2", 4.7),
                                 c("ACCESS-ESM1-5", 3.9),
                                 c("CAMS-CSM1-0", 2.3),
                                 c("CanESM5", 5.6),
                                 c("CESM2", 5.2),
                                 c("CESM2-WACCM", 4.8),
                                 c("CMCC-CM2-SR5", 3.52) ,  
                                 c("HadGEM3-GC31-LL", 5.6),
                                 c("MIROC-ES2L", 2.7),
                                 c("MIROC6", 2.6),
                                 c("MRI-ESM2-0", 3.2),
                                 c("NorESM2-MM", 2.5),
                                 c("TaiESM1", 4.31),        
                                 c("UKESM1-0-LL", 5.3), 
                                 c("CMCC-ESM2", 3.57)))
names(cmip6_ecs) <- c("model", "ecs")

cmip6_ecs %>%  
  mutate(id = "unlikely") %>% 
  mutate(id = ifelse(ecs >= 2 & ecs <= 5, "very likely", id)) -> 
  ecs_table

read.csv(here::here("data", "cmip6_model_means.csv")) %>% 
  #  mutate(model = if_else(grepl(pattern = "CMCC-ESM2", x = model), model, "CMCC-ESM2")) %>% 
  dplyr::filter(scenario %in% scns)  %>% 
  filter(model %in% cmip6_ecs$model) %>% 
  full_join(ecs_table, by = "model") -> 
  cmip6_rslts 

hector_ssp %>% 
  filter(year %in% 1850:2100) %>% 
  filter(scenario %in% paste0(scns, " conc")) %>% 
  mutate(scenario = gsub(pattern = " conc", replacement = "", x = scenario)) %>% 
  filter(version == "3.0.0") %>% 
  filter(variable %in% c(SST(), GLOBAL_TAS(),  LAND_TAS())) -> 
  hector_temp

cmip6_rslts %>% 
  group_by(scenario, year, variable, id) %>% 
  summarise(min = min(value), 
            max = max(value)) -> 
  cmip6_temp_summary

# Create the labels 
temp_labs <- c("Global Mean Air Temp.", "Mean Land Surface Temp.", "Mean Sea Surface Temp.")
names(temp_labs) <-   c(GLOBAL_TAS(), LAND_TAS(), SST())

ggplot() + 
  geom_ribbon(data = cmip6_temp_summary, aes(year, ymin = min, ymax = max, fill = id), alpha = 0.9) + 
  geom_line(data = hector_temp, aes(year, value, color = "Hector v3"), size = 1) + 
  facet_grid(scenario~variable, labeller = labeller(variable = temp_labs), scales = "free") + 
  labs(y = expression("Temperature anomaly relative to 1850-1860 ("~degree~"C)"), x = NULL) + 
  scale_color_manual(values = c("Hector v3" = OBS_SCHEME[["Hector v3"]])) + 
  scale_fill_manual(values = c("very likely" = "#5A5A5A", "unlikely"="#D3D3D3")) + 
  theme(panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(), 
        legend.position = "bottom") + 
   theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) -> 
  plot; plot

ggsave(plot, filename = file.path(FIGS_DIR, "hector_cmip_temps.png"), 
       width = MANUSCRIPT_FIG$width * 1.25, height = MANUSCRIPT_FIG$height * 1.25)

```


# Recreating IPCC SPM10 

```{r, warning=FALSE}
# Read in the IPCC results 
ipcc_data <- read.csv(here::here("data", "IPCC_co2_tas.csv"))
hector_tas_v_co2 <- read.csv(here::here("output", "hector_output", "hector_3.0.0-IPCCemiss_co2_tas.csv"))

colors_to_use <- SSP_COLORS[names(SSP_COLORS) %in% ipcc_data$scenario]

ggplot() +
  geom_ribbon(data = ipcc_data, aes(co2, ymin = min, 
                                    ymax = max, fill = scenario), alpha = 0.1) + 
  #geom_line(data = ipcc_data, aes(co2, mean, group = scenario, color = "IPCC", linetype = "IPCC")) +
  geom_line(data = ipcc_data, aes(co2, obs, color = "Obs", linetype = "Observations")) +
  geom_line(data = hector_tas_v_co2, aes(co2, gmst, color = scenario), size = 0.75) +
  scale_fill_manual(values = colors_to_use) + 
  scale_color_manual(values = colors_to_use) + 
  labs(y = expression("Temperature anomaly relative to 1850-1900 ("~degree~"C)"),
       x = expression("Cumlative "~CO[2]~" Emissions")) + 
  theme_bw(base_size = THEME_BASE_SIZE) +
  theme(plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_linetype_manual(values = c("Observations" = 2)) +
  labs(color = "Hector", fill = "IPCC AR6", linetype = element_blank()) + 
  NULL -> 
  plot; plot

ggsave(plot, filename = file.path(FIGS_DIR, "recreate_IPCC_fig.png"), 
       width = MANUSCRIPT_FIG$width * 2, height = MANUSCRIPT_FIG$height * 1.75)
```



# TODO! 

calcualte TCRE, ZCRE, performance compared with idealized rcmip results & then comoparison with v2 comparisons comparison of co2 dirven and emissions driven? also what about the cmoparison with the [CO2] 

We  use  the  recent  assessment  of  Sherwood  et  al.  (2020)  for  equilibrium  climate  sensitivity  (ECS).  ECS  is  defined  as  the  equilibrium  warming  which  occurs  under  a  doubling  of  atmospheric  CO2  concentrations  relative  to  preindustrial  concentrations.  The  ECS  assessment  is  combined  with  the  constrained  transient  climate response (TCR) assessment of Tokarska et al. (2020). 

TCR is defined as the surface air temperature change  which  occurs  at  the  time  at  which  atmospheric  CO2  concentrations  double  in  an  experiment  in  which atmospheric CO2 concentrations rise at one percent per year (a 1pctCO2 experiment). 

Carbon cycle behavior  is  considered  only  via  the  transient  climate  response  to  emissions  (TCRE).  TCRE  is  defined  as  the  ratio  of  surface  air  temperature  change  to  cumulative  CO2  emissions  at  the  time  when  atmospheric  CO2 concentrations double in a 1pctCO2 experiment. 









