---
title: "Exploring Hector Calibration Protocol"
author: "Kalyn Dorheim"
date: "7/29/2022"
output: html_document
---

# okay how is it that BBL's worked well and mine is not, are the ranges we giving not informative enough? 
are we running into the issues wit beta and q10 trading off with one anohter. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(readr)
library(dplyr)
library(ggplot2); theme_set(theme_bw())
library(tidyr)

library(hector)
if(packageVersion("hector") != '3.0.0') stop("unexpected verrsion of hector")

DATADIR <- here::here("data")
```


# 0. Set Up 


```{r}
ssp245 <- system.file("input/hector_ssp245.ini", package = "hector")
core <- newcore(ssp245)
```

```{r}
# Define name and units of all parameters
name_vector <- c("BETA" = BETA(), "Q10_RH" = Q10_RH(),
                 "ECS" = ECS(), "NPP_FLUX0" = NPP_FLUX0(),
                 "AERO_SCALE" = AERO_SCALE(), "DIFFUSIVITY" = DIFFUSIVITY(),
                 "LUC_SCALAR" = "LUC_SCALAR")

units_vector <- c("BETA" = "(unitless)", "Q10_RH" = "(unitless)",
                  "ECS" = "degC", "NPP_FLUX0" = "Pg C/yr",
                  "AERO_SCALE" = "(unitless)", "DIFFUSIVITY" = "cm2/s",
                  "LUC_SCALAR" = "(unitless)")
```


```{r observations}
# Mauna Loa CO2 - downloaded 2022-05-05 from https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_annmean_mlo.csv
# R actually has this as a built-in dataset but it stops at 1997! Too bad
read_csv(file.path(DATADIR, "co2_annmean_mlo.csv"), col_types = "ddd", comment = "#") %>% 
  rename(value = mean) %>% 
  mutate(which = "Mauna Loa") ->
  OBSERVED_CO2

# NASA GISS temperature - downloaded 2020-05-06 from https://climate.nasa.gov/vital-signs/global-temperature/
OBSERVED_TAS <- read_table(file.path(DATADIR, "giss_temperature.txt"), skip = 5,
                           col_names = c("year", "value"),
                           col_types = "dd-")
OBSERVED_TAS$which <- "NASA GISS"
```

```{r parameters}
# Initial starting values are:
params <- c("BETA" = fetchvars(core, NA, BETA())$value,
            "Q10_RH" = fetchvars(core, NA, Q10_RH())$value,
            "NPP_FLUX0" = fetchvars(core, NA, NPP_FLUX0())$value,
            "AERO_SCALE" = fetchvars(core, NA, AERO_SCALE())$value,
            "ECS" = fetchvars(core, NA, ECS())$value,
            "DIFFUSIVITY" = fetchvars(core, NA, DIFFUSIVITY())$value)

# Standard deviations are based on Leeya's research and code
# https://github.com/JGCRI/trackingC/blob/main/trackingC_setup.Rmd
params_sd <- c("BETA" = 0.2,
               "Q10_RH" = 0.6,
               "NPP_FLUX0" = 14,
               "AERO_SCALE" = 0.5,
               "ECS" = 1.0,
               "DIFFUSIVITY" = 0.23)
params_lower <- params - params_sd
params_upper <- params + params_sd
# Actually AERO_SCALE can't go above 1 or below 0 
params_upper["AERO_SCALE"] <- 1.0
params_lower["AERO_SCALE"] <- 0
```

```{r optim-functions}
set_params <- function(params, core) {
  # For each parameter within each run, set its value and units
  #if(!step %% 10) message(step, " ", Sys.time())
  for(p in names(params)) {
    # If the parameter is a scaling constant, multiply and set scaled values
    if(p == "LUC_SCALAR") {
      setvar(core, luc$year, LUC_EMISSIONS(), (luc$value * params[p]), "Pg C/yr")
    } else {
      # Otherwise, simply set the value of the parameter itself
      setvar(core, NA, do.call(p, list()), params[p], units_vector[p])
    }
  }
}

run_hector <- function(params, core, log = FALSE) {
  # params is a named vector of parameters
  # core is a Hector core
  step <<- step + 1
  
  nss <- tryCatch({
    set_params(params, core)
    
    # Reset and run core
    reset(core)
    run(core, runtodate = max(OBSERVED_CO2$year))
    
    # Get atmospheric [CO2] and compare to observational record
    # We use normalized sum of squares so entire time series is weighted equally
    co2 <- fetchvars(core, OBSERVED_CO2$year, CONCENTRATIONS_CO2())
    out <- sum(((OBSERVED_CO2$value - co2$value) ^ 2) / OBSERVED_CO2$value)
    out
    
  }, error = function(e){9999})
  
  # Log
  if(log) {
    co2$step <- step
    write_csv(co2, CO2LOGFILE, append = TRUE, col_names = !file.exists(CO2LOGFILE))
    params_df <- as.data.frame(t(as.data.frame(params)))
    params_df$NSS <- nss
    params_df$step <- step
    write_csv(params_df, LOGFILE, append = TRUE, col_names = !file.exists(LOGFILE))
  }
  
  # Return normalized sum of squares to optimizer
  return(nss)
}
```

# 1. Run with the old default parameters 

```{r}
old_default_params <- c(beta=0.36, q10_rh=2.0, S=3.0, diff=2.3, alpha=1.0, volscl=1.0, npp_flux0=56.2)
old_default_params_units <- sapply(names(old_default_params), getunits)

x <- mapply(FUN = function(name, val, u){
  setvar(core = core, dates = NA, var = name, values = val, unit = u)
}, 
name = names(old_default_params), 
val = old_default_params, 
u = old_default_params_units)

reset(core)
run(core)
out_default <- fetchvars(core, vars = c(GLOBAL_TAS(), NPP(), ATMOSPHERIC_CO2()), dates = 1750:2100)
out_default$name <- "default params"
```


## BBL's Calibration 
 
Find best fits for the beta, q10, NPP, alpha, S, and diffusivity. 

```{r optimize, cache=TRUE, message=FALSE}
step <- 0
start <- Sys.time()
result <- optim(params, run_hector, gr = NULL, core,
                method = "L-BFGS-B",
                lower = params_lower,
                upper = params_upper)
end <- Sys.time()
shutdown(core)
time_taken <- difftime(end, start, units = "mins")
fit1 <- result
```

```{r}
ssp245 <- system.file("input/hector_ssp245.ini", package = "hector")
core <- newcore(ssp245, name = "ssp245")

set_params(result$par, core)
reset(core)
suppressMessages(run(core))
out_fit1 <- fetchvars(core, vars = c(GLOBAL_TAS(), NPP(), ATMOSPHERIC_CO2()), dates = 1750:2100)
out_fit1$name <- "fit1"
```


## CT's Calibration 
 
Find best fits for the beta, q10, NPP, alpha, and diffusivity. Fix S to the IPCC bes estimate

```{r optimize, cache=TRUE, message=FALSE}

# Initial starting values are:
params <- c("BETA" = fetchvars(core, NA, BETA())$value,
          #  "Q10_RH" = fetchvars(core, NA, Q10_RH())$value,
            "NPP_FLUX0" = fetchvars(core, NA, NPP_FLUX0())$value,
            "AERO_SCALE" = fetchvars(core, NA, AERO_SCALE())$value,
            "DIFFUSIVITY" = fetchvars(core, NA, DIFFUSIVITY())$value)

# Standard deviations are based on Leeya's research and code
# https://github.com/JGCRI/trackingC/blob/main/trackingC_setup.Rmd
params_sd <- c("BETA" = 0.2,
               #"Q10_RH" = 0.6,
               "NPP_FLUX0" = 14,
               "AERO_SCALE" = 0.5,
               "DIFFUSIVITY" = 0.23)
params_lower <- params - params_sd
params_upper <- params + params_sd
# Actually AERO_SCALE can't go above 1 or below 0 
params_upper["AERO_SCALE"] <- 1.0
params_lower["AERO_SCALE"] <- 0
```


```{r}
ssp245 <- system.file("input/hector_ssp245.ini", package = "hector")
core <- newcore(ssp245, name = "ssp245")

setvar(core, NA, var = ECS(), values = 3, unit = getunits(ECS()))

step <- 0
start <- Sys.time()
result <- optim(params, run_hector, gr = NULL, core,
                method = "L-BFGS-B",
                lower = params_lower,
                upper = params_upper)
end <- Sys.time()
shutdown(core)
time_taken <- difftime(end, start, units = "mins")
fit2 <- result
```

```{r}
ssp245 <- system.file("input/hector_ssp245.ini", package = "hector")
core <- newcore(ssp245, name = "ssp245")

set_params(result$par, core)
setvar(core, NA, var = ECS(), values = 3, unit = getunits(ECS()))
reset(core)
suppressMessages(run(core))
out_fit2 <- fetchvars(core, vars = c(GLOBAL_TAS(), NPP(), ATMOSPHERIC_CO2()), dates = 1750:2100)
out_fit2$name <- "fit 2"
```


# Comparisons 

```{r}

out <- bind_rows(out_fit1, out_default, out_fit2)

ggplot(data = out, aes(year, value, color = name)) + 
  geom_line() + 
  facet_wrap("variable", scales = "free")

```






